"""
NoSQL Engine - Simple JSON processing
"""

import json

class NoSQLEngine:
    def __init__(self):
        self.data = None
        self.filename = None
        self.operations = []
    
    def load_data(self, file_obj):
        """Load JSON file"""
        try:
            content = file_obj.read()
            if isinstance(content, bytes):
                content = content.decode('utf-8')
            
            self.data = json.loads(content)
            self.filename = file_obj.name
            self.operations = []
            return True, f"Loaded {self.filename}"
        except Exception as e:
            return False, f"Error: {str(e)}"
    
    def is_loaded(self):
        return self.data is not None
    
    def get_info(self):
        if isinstance(self.data, list):
            return {
                'filename': self.filename,
                'count': len(self.data),
                'type': 'Array'
            }
        else:
            return {
                'filename': self.filename,
                'count': 1,
                'type': 'Object'
            }
    
    def preview(self, n=5):
        if isinstance(self.data, list):
            return self.data[:n]
        else:
            return [self.data]
    
    def get_fields(self):
        """Get field names from first document"""
        if not self.data:
            return []
        
        sample = self.data[0] if isinstance(self.data, list) else self.data
        return self._extract_fields(sample)
    
    def _extract_fields(self, obj, prefix=''):
        """Extract field names recursively"""
        fields = []
        if isinstance(obj, dict):
            for key, value in obj.items():
                field_name = f"{prefix}.{key}" if prefix else key
                fields.append(field_name)
                if isinstance(value, dict):
                    fields.extend(self._extract_fields(value, field_name))
        return fields
    
    def add_filter(self, field, operator, value):
        self.operations.append({
            'type': 'filter',
            'field': field,
            'operator': operator,
            'value': value,
            'description': f"Filter: {field} {operator} {value}"
        })
    
    def add_projection(self, fields):
        self.operations.append({
            'type': 'project',
            'fields': fields,
            'description': f"Project: {', '.join(fields)}"
        })
    
    def add_groupby(self, field):
        self.operations.append({
            'type': 'groupby',
            'field': field,
            'description': f"Group By: {field}"
        })
    
    def add_limit(self, n):
        self.operations.append({
            'type': 'limit',
            'value': n,
            'description': f"Limit: {n}"
        })
    
    def get_operations(self):
        return self.operations
    
    def remove_operation(self, index):
        if 0 <= index < len(self.operations):
            self.operations.pop(index)
    
    def clear_operations(self):
        self.operations = []
    
    def execute(self):
        """Execute operations"""
        try:
            from nosql_executor import NoSQLExecutor
            executor = NoSQLExecutor(self.data)
            return executor.execute(self.operations)
        except Exception as e:
            print(f"Error: {e}")
            return None
